<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quotation Automation System</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <!-- ExcelJS -->
    <script src="https://cdn.jsdelivr.net/npm/exceljs@4.4.0/dist/exceljs.min.js"></script>
    <!-- FileSaver -->
    <script src="https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js"></script>
    <style>
        body {
            background-color: #f8f9fa;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        .navbar {
            background: linear-gradient(135deg, #2c3e50 0%, #4a6491 100%);
        }
        
        .card {
            border: none;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        
        .card-header {
            background: #3498db;
            color: white;
            border-radius: 8px 8px 0 0 !important;
            padding: 12px 20px;
            font-weight: 600;
        }
        
        .btn-primary {
            background: #3498db;
            border: none;
        }
        
        .btn-success {
            background: #27ae60;
            border: none;
        }
        
        .btn-warning {
            background: #f39c12;
            border: none;
        }
        
        .btn-danger {
            background: #e74c3c;
            border: none;
        }
        
        .btn-info {
            background: #17a2b8;
            border: none;
        }
        
        .table th {
            background-color: #f1f8ff;
            font-weight: 600;
        }
        
        .table td {
            vertical-align: middle;
        }
        
        .form-control:focus {
            border-color: #3498db;
            box-shadow: 0 0 0 0.2rem rgba(52, 152, 219, 0.25);
        }
        
        .total-section {
            background: #2c3e50;
            color: white;
            padding: 20px;
            border-radius: 8px;
        }
        
        @media print {
            .no-print {
                display: none !important;
            }
        }
        
        .form-label {
            font-weight: 500;
            color: #2c3e50;
        }
        
        .item-search-container {
            position: relative;
        }
        
        .search-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 0 0 6px 6px;
            max-height: 300px;
            overflow-y: auto;
            z-index: 1000;
            display: none;
        }
        
        .search-dropdown-item {
            padding: 8px 12px;
            cursor: pointer;
            border-bottom: 1px solid #f1f1f1;
        }
        
        .search-dropdown-item:hover {
            background-color: #f8f9fa;
        }
        
        .item-details-card {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        
        .amount-cell {
            font-weight: 600;
            color: #2c3e50;
        }
        
        .unit-badge {
            display: inline-block;
            background: #e3f2fd;
            color: #3498db;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
            margin-right: 5px;
            margin-bottom: 5px;
            cursor: pointer;
        }
        
        .category-badge {
            display: inline-block;
            background: #f0f7ff;
            color: #2c3e50;
            padding: 4px 10px;
            border-radius: 15px;
            font-size: 12px;
            font-weight: 500;
            margin: 2px;
            border: 1px solid #dee2e6;
            cursor: pointer;
        }
        
        .search-highlight {
            background-color: #fff3cd;
            padding: 1px 2px;
            border-radius: 2px;
        }
        
        .main-items-section {
            border-top: 2px solid #3498db;
            padding-top: 20px;
            margin-top: 20px;
        }
        
        .additional-items-section {
            border-top: 2px solid #f39c12;
            padding-top: 20px;
            margin-top: 20px;
        }
        
        .section-title {
            color: #2c3e50;
            border-bottom: 2px solid;
            padding-bottom: 8px;
            margin-bottom: 15px;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        .btn-sm {
            padding: 4px 8px;
            font-size: 12px;
        }
        
        .modal-header {
            background: #3498db;
            color: white;
        }
        
        .voucher-list-item {
            padding: 10px;
            border-bottom: 1px solid #dee2e6;
            cursor: pointer;
        }
        
        .voucher-list-item:hover {
            background-color: #f8f9fa;
        }
        
        .voucher-list-item.active {
            background-color: #e3f2fd;
            border-left: 4px solid #3498db;
        }
        
        .saved-vouchers-section {
            max-height: 300px;
            overflow-y: auto;
        }
        
        .additional-item-select-container {
            position: relative;
        }
        
        .additional-search-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 0 0 6px 6px;
            max-height: 300px;
            overflow-y: auto;
            z-index: 1000;
            display: none;
        }
        
        .additional-search-dropdown-item {
            padding: 8px 12px;
            cursor: pointer;
            border-bottom: 1px solid #f1f1f1;
        }
        
        .additional-search-dropdown-item:hover {
            background-color: #f8f9fa;
        }
        
        .packing-badge {
            display: inline-block;
            background: #e8f5e8;
            color: #27ae60;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 500;
            margin-right: 3px;
            margin-bottom: 3px;
            cursor: pointer;
        }
        
        .additional-item-amount {
            font-weight: 600;
            color: #f39c12;
            padding: 8px;
            background: #fff8e1;
            border-radius: 4px;
            text-align: center;
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar navbar-dark">
        <div class="container-fluid">
            <a class="navbar-brand" href="#">
                <i class="bi bi-file-earmark-spreadsheet me-2"></i>
                Quotation Automation
            </a>
            <div class="d-flex">
                <button class="btn btn-outline-light me-2 no-print" onclick="saveQuotation()">
                    <i class="bi bi-save"></i> Save
                </button>
                <button class="btn btn-info me-2 no-print" onclick="manageVouchers()">
                    <i class="bi bi-files"></i> Vouchers
                </button>
                <button class="btn btn-success me-2 no-print" onclick="exportToExcel()">
                    <i class="bi bi-file-excel"></i> Export
                </button>
                <button class="btn btn-warning no-print" onclick="window.print()">
                    <i class="bi bi-printer"></i> Print
                </button>
            </div>
        </div>
    </nav>

    <!-- Main Container -->
    <div class="container-fluid mt-4">
        <div class="row">
            <!-- Left Column - Main Content -->
            <div class="col-lg-8">
                <!-- Quotation Header -->
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="bi bi-info-circle me-2"></i> Quotation Information</h5>
                    </div>
                    <div class="card-body">
                        <div class="row g-3">
                            <div class="col-md-3">
                                <label class="form-label">Quote #</label>
                                <input type="text" class="form-control" id="quoteNumber" value="Q-2026-001">
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">Date</label>
                                <input type="date" class="form-control" id="quoteDate" value="2026-02-05">
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">Customer ID</label>
                                <input type="text" class="form-control" id="customerId" value="70226">
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">Valid Until</label>
                                <input type="date" class="form-control" id="validUntil" value="2026-03-05">
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Customer Name</label>
                                <input type="text" class="form-control" id="customerName" placeholder="Enter customer name">
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">PO Number</label>
                                <input type="text" class="form-control" id="poNumber" value="301/26/00029">
                            </div>
                            <div class="col-12">
                                <label class="form-label">Customer Address</label>
                                <textarea class="form-control" id="customerAddress" rows="2" placeholder="Enter customer address"></textarea>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Add Items Section -->
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0"><i class="bi bi-plus-circle me-2"></i> Add Items</h5>
                        <button class="btn btn-sm btn-outline-primary" onclick="showAddItemModal()">
                            <i class="bi bi-plus-lg"></i> Add to Library
                        </button>
                    </div>
                    <div class="card-body">
                        <!-- Item Search with Dropdown Selection -->
                        <div class="item-search-container mb-3">
                            <label class="form-label">Search Item or Select from Library</label>
                            <div class="input-group">
                                <span class="input-group-text"><i class="bi bi-search"></i></span>
                                <input type="text" class="form-control" id="itemSearch" 
                                       placeholder="Type to search items..." 
                                       autocomplete="off"
                                       oninput="searchItems()">
                                <select class="form-select" id="itemSelect" style="max-width: 200px;" onchange="selectItemFromDropdown(this.value)">
                                    <option value="">Select from Library</option>
                                    <!-- Options will be populated dynamically -->
                                </select>
                            </div>
                            <div id="searchDropdown" class="search-dropdown">
                                <!-- Search results appear here -->
                            </div>
                        </div>
                        
                        <!-- Selected Item Details -->
                        <div id="itemDetails" class="item-details-card" style="display: none;">
                            <div class="row g-3">
                                <div class="col-md-3">
                                    <label class="form-label">Item Name</label>
                                    <input type="text" class="form-control" id="selectedItemName" readonly>
                                </div>
                                <div class="col-md-2">
                                    <label class="form-label">Category</label>
                                    <input type="text" class="form-control" id="selectedItemCategory" readonly>
                                </div>
                                <div class="col-md-2">
                                    <label class="form-label">Packing</label>
                                    <input type="text" class="form-control" id="selectedItemPacking" placeholder="e.g., 1 x 20 Kg">
                                    <div class="mt-1">
                                        <small>Common packing:</small>
                                        <div>
                                            <span class="packing-badge" onclick="setPacking('1 x 20 Kg')">1x20Kg</span>
                                            <span class="packing-badge" onclick="setPacking('1 x 10 Kg')">1x10Kg</span>
                                            <span class="packing-badge" onclick="setPacking('1 x 5 Kg')">1x5Kg</span>
                                            <span class="packing-badge" onclick="setPacking('1 x 2 Kg')">1x2Kg</span>
                                            <span class="packing-badge" onclick="setPacking('1 x 1 Kg')">1x1Kg</span>
                                            <span class="packing-badge" onclick="setPacking('1 x 12 pcs')">1x12pcs</span>
                                            <span class="packing-badge" onclick="setPacking('1 x 24 pcs')">1x24pcs</span>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-2">
                                    <label class="form-label">Unit</label>
                                    <input type="text" class="form-control" id="selectedItemUnit" 
                                           onchange="calculateItemAmount()">
                                    <div class="mt-1">
                                        <small>Common units:</small>
                                        <div>
                                            <span class="unit-badge" onclick="setUnit('Kg')">Kg</span>
                                            <span class="unit-badge" onclick="setUnit('C/s')">C/s</span>
                                            <span class="unit-badge" onclick="setUnit('CTN')">CTN</span>
                                            <span class="unit-badge" onclick="setUnit('Pkt')">Pkt</span>
                                            <span class="unit-badge" onclick="setUnit('Btl')">Btl</span>
                                            <span class="unit-badge" onclick="setUnit('Tin')">Tin</span>
                                            <span class="unit-badge" onclick="setUnit('Box')">Box</span>
                                            <span class="unit-badge" onclick="setUnit('Each')">Each</span>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-1">
                                    <label class="form-label">Qty</label>
                                    <input type="number" class="form-control" id="selectedItemQty" 
                                           value="1" min="0.01" step="0.01"
                                           oninput="calculateItemAmount()">
                                </div>
                                <div class="col-md-2">
                                    <label class="form-label">Rate (SAR)</label>
                                    <input type="number" class="form-control" id="selectedItemRate" 
                                           value="0" min="0" step="0.001"
                                           oninput="calculateItemAmount()">
                                </div>
                            </div>
                            <div class="row mt-2">
                                <div class="col-md-6">
                                    <label class="form-label">Remarks</label>
                                    <input type="text" class="form-control" id="selectedItemRemarks" placeholder="Enter remarks">
                                </div>
                                <div class="col-md-3">
                                    <div class="form-group">
                                        <label class="form-label">Amount (SAR)</label>
                                        <input type="text" class="form-control fw-bold amount-cell" 
                                               id="selectedItemAmount" readonly value="0.00">
                                    </div>
                                </div>
                                <div class="col-md-3 d-flex align-items-end">
                                    <button class="btn btn-primary me-2" onclick="addToMainItems()">
                                        <i class="bi bi-plus-circle"></i> Add to Main
                                    </button>
                                    <button class="btn btn-warning" onclick="addToAdditionalItems()">
                                        <i class="bi bi-plus-square"></i> Add to Additional
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Main Items Section -->
                <div class="main-items-section">
                    <h5 class="section-title" style="border-bottom-color: #3498db;">
                        <i class="bi bi-cart me-2"></i> Main Items
                    </h5>
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th width="5%">SL#</th>
                                    <th width="20%">Item Name</th>
                                    <th width="12%">Category</th>
                                    <th width="12%">Packing</th>
                                    <th width="8%">Unit</th>
                                    <th width="8%">Qty</th>
                                    <th width="12%">Rate (SAR)</th>
                                    <th width="12%">Amount (SAR)</th>
                                    <th width="6%">Remarks</th>
                                    <th width="5%"></th>
                                </tr>
                            </thead>
                            <tbody id="mainItemsBody">
                                <!-- Main items appear here -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Additional Items Section -->
                <div class="additional-items-section">
                    <h5 class="section-title" style="border-bottom-color: #f39c12;">
                        <i class="bi bi-plus-square me-2"></i> Additional Items
                    </h5>
                    
                    <!-- Add Additional Item Form -->
                    <div class="item-details-card mb-3">
                        <div class="row g-3">
                            <div class="col-md-3">
                                <label class="form-label">Select Item</label>
                                <div class="additional-item-select-container">
                                    <div class="input-group">
                                        <span class="input-group-text"><i class="bi bi-search"></i></span>
                                        <input type="text" class="form-control" id="additionalItemSearch" 
                                               placeholder="Search item..." 
                                               autocomplete="off"
                                               oninput="searchAdditionalItems()">
                                        <select class="form-select" id="additionalItemSelect" onchange="selectAdditionalItemFromDropdown(this.value)">
                                            <option value="">Select from Library</option>
                                            <!-- Options will be populated dynamically -->
                                        </select>
                                    </div>
                                    <div id="additionalSearchDropdown" class="additional-search-dropdown">
                                        <!-- Search results appear here -->
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-2">
                                <label class="form-label">Packing</label>
                                <input type="text" class="form-control" id="additionalItemPacking" placeholder="Packing">
                            </div>
                            <div class="col-md-2">
                                <label class="form-label">Unit</label>
                                <input type="text" class="form-control" id="additionalItemUnit" placeholder="Unit">
                            </div>
                            <div class="col-md-1">
                                <label class="form-label">Quantity</label>
                                <input type="number" class="form-control" id="additionalItemQty" value="1" min="0.01" step="0.01" oninput="calculateAdditionalItemAmount()">
                            </div>
                            <div class="col-md-2">
                                <label class="form-label">Rate (SAR)</label>
                                <input type="number" class="form-control" id="additionalItemRate" value="0" min="0" step="0.001" oninput="calculateAdditionalItemAmount()">
                            </div>
                            <div class="col-md-2">
                                <label class="form-label">Remarks</label>
                                <input type="text" class="form-control" id="additionalItemRemarks" placeholder="Remarks">
                            </div>
                        </div>
                        <div class="row mt-3">
                            <div class="col-md-4">
                                <div class="additional-item-amount">
                                    <small class="text-muted">Amount:</small>
                                    <div id="additionalItemAmountDisplay" class="fw-bold">0.00 SAR</div>
                                </div>
                            </div>
                            <div class="col-md-8">
                                <div class="d-flex gap-2 justify-content-end">
                                    <button class="btn btn-warning" onclick="addAdditionalItem()">
                                        <i class="bi bi-plus-circle"></i> Add Item
                                    </button>
                                    <button class="btn btn-outline-secondary" onclick="clearAdditionalForm()">
                                        <i class="bi bi-x-circle"></i> Clear
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th width="5%">SL#</th>
                                    <th width="20%">Item Name</th>
                                    <th width="12%">Packing</th>
                                    <th width="8%">Unit</th>
                                    <th width="8%">Qty</th>
                                    <th width="12%">Rate (SAR)</th>
                                    <th width="12%">Amount (SAR)</th>
                                    <th width="18%">Remarks</th>
                                    <th width="5%"></th>
                                </tr>
                            </thead>
                            <tbody id="additionalItemsBody">
                                <!-- Additional items appear here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            
            <!-- Right Column - Sidebar -->
            <div class="col-lg-4">
                <!-- Quick Categories -->
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="bi bi-tags me-2"></i> Quick Categories</h5>
                    </div>
                    <div class="card-body">
                        <div id="quickCategories">
                            <!-- Categories appear here -->
                        </div>
                    </div>
                </div>
                
                <!-- Summary Panel -->
                <div class="total-section">
                    <h5 class="card-title mb-4"><i class="bi bi-calculator me-2"></i> Quotation Summary</h5>
                    <div class="mb-3">
                        <div class="d-flex justify-content-between mb-2">
                            <span>Main Items:</span>
                            <span id="mainTotal" class="fw-bold">0.00 SAR</span>
                        </div>
                        <div class="d-flex justify-content-between mb-2">
                            <span>Additional Items:</span>
                            <span id="additionalTotal" class="fw-bold">0.00 SAR</span>
                        </div>
                        <hr class="bg-white">
                        <div class="d-flex justify-content-between">
                            <span class="fs-5">GRAND TOTAL:</span>
                            <span id="grandTotal" class="fs-4 fw-bold">0.00 SAR</span>
                        </div>
                    </div>
                    <div class="mt-4">
                        <button class="btn btn-light w-100 mb-2" onclick="calculateTotals()">
                            <i class="bi bi-arrow-clockwise"></i> Recalculate Totals
                        </button>
                        <button class="btn btn-success w-100" onclick="exportToExcel()">
                            <i class="bi bi-download"></i> Download Excel
                        </button>
                    </div>
                </div>
                
                <!-- Data Management -->
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="bi bi-database me-2"></i> Data Management</h5>
                    </div>
                    <div class="card-body">
                        <div class="d-grid gap-2">
                            <button class="btn btn-outline-primary" onclick="loadSampleQuotation()">
                                <i class="bi bi-cloud-download"></i> Load Sample
                            </button>
                            <button class="btn btn-outline-danger" onclick="clearQuotationData()">
                                <i class="bi bi-trash"></i> Clear Quotation
                            </button>
                            <button class="btn btn-outline-warning" onclick="manageItemLibrary()">
                                <i class="bi bi-box"></i> Manage Item Library
                            </button>
                            <button class="btn btn-outline-info" onclick="importAllItemsFromExcel()">
                                <i class="bi bi-upload"></i> Import All Items
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modals -->
    <!-- Add Item to Library Modal -->
    <div class="modal fade" id="addItemModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Add New Item to Library</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Item Name</label>
                        <input type="text" class="form-control" id="newItemName">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Category</label>
                        <input type="text" class="form-control" id="newItemCategory" list="categoryList">
                        <datalist id="categoryList">
                            <!-- Categories will be populated -->
                        </datalist>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Default Packing</label>
                        <input type="text" class="form-control" id="newItemPacking" placeholder="e.g., 1 x 20 Kg">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Unit</label>
                        <input type="text" class="form-control" id="newItemUnit">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Default Rate (SAR)</label>
                        <input type="number" class="form-control" id="newItemRate" step="0.001" min="0">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="addItemToLibrary()">Add to Library</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Manage Item Library Modal -->
    <div class="modal fade" id="itemLibraryModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Manage Item Library</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Name</th>
                                    <th>Category</th>
                                    <th>Packing</th>
                                    <th>Unit</th>
                                    <th>Rate (SAR)</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="itemLibraryTable">
                                <!-- Items will be populated here -->
                            </tbody>
                        </table>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" onclick="exportItemLibrary()">
                        <i class="bi bi-download"></i> Export Library
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Voucher Management Modal -->
    <div class="modal fade" id="voucherModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Manage Vouchers</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-4 saved-vouchers-section">
                            <h6>Saved Vouchers</h6>
                            <div id="voucherList">
                                <!-- Vouchers will appear here -->
                            </div>
                        </div>
                        <div class="col-md-8">
                            <div class="mb-3">
                                <label class="form-label">Voucher Name</label>
                                <input type="text" class="form-control" id="voucherName" placeholder="Enter voucher name">
                            </div>
                            <div class="d-grid gap-2">
                                <button class="btn btn-success" onclick="saveCurrentAsVoucher()">
                                    <i class="bi bi-save"></i> Save Current as New Voucher
                                </button>
                                <button class="btn btn-primary" onclick="loadSelectedVoucher()" id="loadVoucherBtn" disabled>
                                    <i class="bi bi-folder"></i> Load Selected Voucher
                                </button>
                                <button class="btn btn-warning" onclick="updateSelectedVoucher()" id="updateVoucherBtn" disabled>
                                    <i class="bi bi-arrow-clockwise"></i> Update Selected Voucher
                                </button>
                                <button class="btn btn-danger" onclick="deleteSelectedVoucher()" id="deleteVoucherBtn" disabled>
                                    <i class="bi bi-trash"></i> Delete Selected Voucher
                                </button>
                                <button class="btn btn-info" onclick="showImportVoucherModal()">
                                    <i class="bi bi-upload"></i> Import Voucher
                                </button>
                                <button class="btn btn-outline-primary" onclick="exportSelectedVoucher()" id="exportVoucherBtn" disabled>
                                    <i class="bi bi-download"></i> Export Selected Voucher
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Import Voucher Modal -->
    <div class="modal fade" id="importVoucherModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Import Voucher</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Select Voucher File (JSON)</label>
                        <input type="file" class="form-control" id="voucherFileInput" accept=".json">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Or Paste Voucher JSON Data</label>
                        <textarea class="form-control" id="voucherJsonInput" rows="6" placeholder='Paste JSON data here...'></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="importVoucher()">Import Voucher</button>
                </div>
            </div>
        </div>
    </div>

    <!-- JavaScript -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // ==================== DATA ====================
        // Complete Item Library from Excel Sample with packing information
        const completeItemLibrary = [
            // FRESH FRUITS & VEGETABLES with packing info
            { name: "APPLE RED", category: "FRESH FRUITS & VEGETABLES", packing: "1 x 20 Kg", unit: "Kg", rate: 9.00 },
            { name: "AVACODO", category: "FRESH FRUITS & VEGETABLES", packing: "1 x 2 Kg", unit: "Kg", rate: 13.50 },
            { name: "BANANA DELMONTY - GREEN", category: "FRESH FRUITS & VEGETABLES", packing: "1 x 13 Kg", unit: "Kg", rate: 7.50 },
            // ... (rest of your items - they are already in the previous code)
        ];

        // Load item library from localStorage or use complete library
        let itemLibrary = JSON.parse(localStorage.getItem('itemLibrary')) || completeItemLibrary;

        // Get unique categories
        let categories = [...new Set(itemLibrary.map(item => item.category))];

        // Application state
        let mainItems = [];
        let additionalItems = [];
        let selectedItem = null;
        let selectedVoucherId = null;

        // ==================== INITIALIZATION ====================
        document.addEventListener('DOMContentLoaded', function() {
            initApp();
            setupEventListeners();
        });

        function initApp() {
            loadFromLocalStorage();
            renderQuickCategories();
            renderMainItems();
            renderAdditionalItems();
            populateItemSelect();
            populateAdditionalItemSelect();
            calculateTotals();
            populateCategoryList();
        }

        function setupEventListeners() {
            // Close dropdowns when clicking outside
            document.addEventListener('click', function(event) {
                const dropdown = document.getElementById('searchDropdown');
                const searchBox = document.getElementById('itemSearch');
                const additionalDropdown = document.getElementById('additionalSearchDropdown');
                const additionalSearchBox = document.getElementById('additionalItemSearch');
                
                if (!searchBox.contains(event.target) && !dropdown.contains(event.target)) {
                    dropdown.style.display = 'none';
                }
                
                if (!additionalSearchBox.contains(event.target) && !additionalDropdown.contains(event.target)) {
                    additionalDropdown.style.display = 'none';
                }
            });
            
            // Calculate amount when quantity or rate changes
            document.getElementById('selectedItemQty').addEventListener('input', calculateItemAmount);
            document.getElementById('selectedItemRate').addEventListener('input', calculateItemAmount);
            document.getElementById('selectedItemUnit').addEventListener('input', calculateItemAmount);
            
            // Additional item form events
            document.getElementById('additionalItemQty').addEventListener('input', calculateAdditionalItemAmount);
            document.getElementById('additionalItemRate').addEventListener('input', calculateAdditionalItemAmount);
        }

        // ==================== SEARCH & DROPDOWN FUNCTIONALITY ====================
        function populateItemSelect() {
            const select = document.getElementById('itemSelect');
            select.innerHTML = '<option value="">Select from Library</option>';
            
            // Group items by category for better organization
            categories.forEach(category => {
                const optgroup = document.createElement('optgroup');
                optgroup.label = category;
                
                itemLibrary
                    .filter(item => item.category === category)
                    .forEach(item => {
                        const option = document.createElement('option');
                        option.value = item.name;
                        option.textContent = `${item.name} (${item.unit} - ${item.rate.toFixed(2)} SAR)`;
                        optgroup.appendChild(option);
                    });
                
                select.appendChild(optgroup);
            });
        }

        function populateAdditionalItemSelect() {
            const select = document.getElementById('additionalItemSelect');
            select.innerHTML = '<option value="">Select from Library</option>';
            
            // Group items by category for better organization
            categories.forEach(category => {
                const optgroup = document.createElement('optgroup');
                optgroup.label = category;
                
                itemLibrary
                    .filter(item => item.category === category)
                    .forEach(item => {
                        const option = document.createElement('option');
                        option.value = item.name;
                        option.textContent = `${item.name} (${item.unit} - ${item.rate.toFixed(2)} SAR)`;
                        optgroup.appendChild(option);
                    });
                
                select.appendChild(optgroup);
            });
        }

        function selectItemFromDropdown(itemName) {
            if (!itemName) return;
            
            const item = itemLibrary.find(i => i.name === itemName);
            if (item) {
                selectedItem = item;
                
                // Fill form
                document.getElementById('selectedItemName').value = item.name;
                document.getElementById('selectedItemCategory').value = item.category;
                document.getElementById('selectedItemPacking').value = item.packing || '';
                document.getElementById('selectedItemUnit').value = item.unit;
                document.getElementById('selectedItemRate').value = item.rate;
                document.getElementById('selectedItemQty').value = 1;
                document.getElementById('selectedItemRemarks').value = '';
                
                // Calculate initial amount
                calculateItemAmount();
                
                // Show item details
                document.getElementById('itemDetails').style.display = 'block';
                
                // Scroll to item details
                document.getElementById('itemDetails').scrollIntoView({ behavior: 'smooth' });
            }
        }

        function searchAdditionalItems() {
            const searchTerm = document.getElementById('additionalItemSearch').value.toLowerCase().trim();
            const dropdown = document.getElementById('additionalSearchDropdown');
            
            if (!searchTerm) {
                dropdown.style.display = 'none';
                return;
            }
            
            // Filter items by name
            const results = itemLibrary.filter(item => 
                item.name.toLowerCase().includes(searchTerm) ||
                item.category.toLowerCase().includes(searchTerm)
            ).slice(0, 10); // Limit to 10 results
            
            if (results.length === 0) {
                dropdown.innerHTML = '<div class="additional-search-dropdown-item text-muted">No items found</div>';
                dropdown.style.display = 'block';
                return;
            }
            
            // Highlight search term in results
            dropdown.innerHTML = results.map(item => {
                const highlightedName = highlightText(item.name, searchTerm);
                const highlightedCategory = highlightText(item.category, searchTerm);
                
                return `
                    <div class="additional-search-dropdown-item" 
                         onclick="selectAdditionalItemFromSearch('${item.name.replace(/'/g, "\\'")}')">
                        <div class="fw-bold">${highlightedName}</div>
                        <div class="small text-muted">
                            <span>${item.unit} | ${item.rate.toFixed(2)} SAR</span>
                            <span class="ms-2">${highlightedCategory}</span>
                        </div>
                    </div>
                `;
            }).join('');
            
            dropdown.style.display = 'block';
        }

        function selectAdditionalItemFromSearch(itemName) {
            const item = itemLibrary.find(i => i.name === itemName);
            
            if (item) {
                // Fill additional item form
                document.getElementById('additionalItemSearch').value = item.name;
                document.getElementById('additionalItemPacking').value = item.packing || '';
                document.getElementById('additionalItemUnit').value = item.unit;
                document.getElementById('additionalItemRate').value = item.rate;
                document.getElementById('additionalItemQty').value = 1;
                document.getElementById('additionalItemRemarks').value = '';
                
                // Hide dropdown
                document.getElementById('additionalSearchDropdown').style.display = 'none';
                
                // Calculate amount
                calculateAdditionalItemAmount();
                
                // Focus on quantity field
                document.getElementById('additionalItemQty').focus();
            }
        }

        function selectAdditionalItemFromDropdown(itemName) {
            if (!itemName) return;
            
            const item = itemLibrary.find(i => i.name === itemName);
            if (item) {
                // Fill additional item form
                document.getElementById('additionalItemSearch').value = item.name;
                document.getElementById('additionalItemPacking').value = item.packing || '';
                document.getElementById('additionalItemUnit').value = item.unit;
                document.getElementById('additionalItemRate').value = item.rate;
                document.getElementById('additionalItemQty').value = 1;
                document.getElementById('additionalItemRemarks').value = '';
                
                // Calculate amount
                calculateAdditionalItemAmount();
                
                // Focus on quantity field
                document.getElementById('additionalItemQty').focus();
            }
        }

        function calculateAdditionalItemAmount() {
            const qty = parseFloat(document.getElementById('additionalItemQty').value) || 0;
            const rate = parseFloat(document.getElementById('additionalItemRate').value) || 0;
            const amount = qty * rate;
            document.getElementById('additionalItemAmountDisplay').textContent = amount.toFixed(2) + ' SAR';
        }

        function searchItems() {
            const searchTerm = document.getElementById('itemSearch').value.toLowerCase().trim();
            const dropdown = document.getElementById('searchDropdown');
            
            if (!searchTerm) {
                dropdown.style.display = 'none';
                return;
            }
            
            // Filter items by name
            const results = itemLibrary.filter(item => 
                item.name.toLowerCase().includes(searchTerm) ||
                item.category.toLowerCase().includes(searchTerm)
            ).slice(0, 10); // Limit to 10 results
            
            if (results.length === 0) {
                dropdown.innerHTML = '<div class="search-dropdown-item text-muted">No items found</div>';
                dropdown.style.display = 'block';
                return;
            }
            
            // Highlight search term in results
            dropdown.innerHTML = results.map(item => {
                const highlightedName = highlightText(item.name, searchTerm);
                const highlightedCategory = highlightText(item.category, searchTerm);
                
                return `
                    <div class="search-dropdown-item" 
                         onclick="selectItemFromSearch('${item.name.replace(/'/g, "\\'")}')">
                        <div class="fw-bold">${highlightedName}</div>
                        <div class="small text-muted">
                            <span>${item.unit} | ${item.rate.toFixed(2)} SAR</span>
                            <span class="ms-2">${highlightedCategory}</span>
                        </div>
                    </div>
                `;
            }).join('');
            
            dropdown.style.display = 'block';
        }

        function highlightText(text, searchTerm) {
            if (!searchTerm) return text;
            
            const regex = new RegExp(`(${searchTerm})`, 'gi');
            return text.replace(regex, '<span class="search-highlight">$1</span>');
        }

        function selectItemFromSearch(itemName) {
            const item = itemLibrary.find(i => i.name === itemName);
            
            if (item) {
                selectedItem = item;
                
                // Fill form
                document.getElementById('selectedItemName').value = item.name;
                document.getElementById('selectedItemCategory').value = item.category;
                document.getElementById('selectedItemPacking').value = item.packing || '';
                document.getElementById('selectedItemUnit').value = item.unit;
                document.getElementById('selectedItemRate').value = item.rate;
                document.getElementById('selectedItemQty').value = 1;
                document.getElementById('selectedItemRemarks').value = '';
                
                // Calculate initial amount
                calculateItemAmount();
                
                // Show item details
                document.getElementById('itemDetails').style.display = 'block';
                
                // Hide dropdown and clear search
                document.getElementById('searchDropdown').style.display = 'none';
                document.getElementById('itemSearch').value = '';
                
                // Scroll to item details
                document.getElementById('itemDetails').scrollIntoView({ behavior: 'smooth' });
            }
        }

        function setUnit(unit) {
            document.getElementById('selectedItemUnit').value = unit;
            calculateItemAmount();
        }

        function setPacking(packing) {
            document.getElementById('selectedItemPacking').value = packing;
        }

        function calculateItemAmount() {
            const qty = parseFloat(document.getElementById('selectedItemQty').value) || 0;
            const rate = parseFloat(document.getElementById('selectedItemRate').value) || 0;
            const amount = qty * rate;
            document.getElementById('selectedItemAmount').value = amount.toFixed(2);
        }

        function clearSelectedItem() {
            selectedItem = null;
            document.getElementById('itemDetails').style.display = 'none';
            document.getElementById('itemSearch').value = '';
            document.getElementById('itemSelect').value = '';
            document.getElementById('itemSearch').focus();
        }

        function clearAdditionalForm() {
            document.getElementById('additionalItemSearch').value = '';
            document.getElementById('additionalItemPacking').value = '';
            document.getElementById('additionalItemUnit').value = '';
            document.getElementById('additionalItemQty').value = 1;
            document.getElementById('additionalItemRate').value = 0;
            document.getElementById('additionalItemRemarks').value = '';
            document.getElementById('additionalItemSelect').value = '';
            document.getElementById('additionalItemAmountDisplay').textContent = '0.00 SAR';
        }

        // ==================== ITEM MANAGEMENT ====================
        function addToMainItems() {
            if (!selectedItem) {
                alert('Please select an item first');
                return;
            }
            
            const qty = parseFloat(document.getElementById('selectedItemQty').value) || 0;
            const packing = document.getElementById('selectedItemPacking').value.trim();
            const unit = document.getElementById('selectedItemUnit').value.trim();
            const rate = parseFloat(document.getElementById('selectedItemRate').value) || 0;
            const remarks = document.getElementById('selectedItemRemarks').value.trim();
            
            if (qty <= 0) {
                alert('Please enter a valid quantity');
                return;
            }
            
            if (!unit) {
                alert('Please enter a unit');
                return;
            }
            
            mainItems.push({
                name: selectedItem.name,
                category: selectedItem.category,
                packing: packing,
                unit: unit,
                qty: qty,
                rate: rate,
                remarks: remarks,
                amount: qty * rate // Store amount directly
            });
            
            renderMainItems();
            calculateTotals();
            saveToLocalStorage();
            
            // Reset form
            clearSelectedItem();
            
            showToast(`${selectedItem.name} added to main items!`, 'success');
        }

        function addToAdditionalItems() {
            if (!selectedItem) {
                alert('Please select an item first');
                return;
            }
            
            const qty = parseFloat(document.getElementById('selectedItemQty').value) || 0;
            const packing = document.getElementById('selectedItemPacking').value.trim();
            const unit = document.getElementById('selectedItemUnit').value.trim();
            const rate = parseFloat(document.getElementById('selectedItemRate').value) || 0;
            const remarks = document.getElementById('selectedItemRemarks').value.trim();
            
            if (qty <= 0) {
                alert('Please enter a valid quantity');
                return;
            }
            
            if (!unit) {
                alert('Please enter a unit');
                return;
            }
            
            additionalItems.push({
                name: selectedItem.name,
                category: selectedItem.category,
                packing: packing,
                unit: unit,
                qty: qty,
                rate: rate,
                remarks: remarks,
                amount: qty * rate // Store amount directly
            });
            
            renderAdditionalItems();
            calculateTotals();
            saveToLocalStorage();
            
            // Reset form
            clearSelectedItem();
            
            showToast(`${selectedItem.name} added to additional items!`, 'success');
        }

        function addAdditionalItem() {
            const name = document.getElementById('additionalItemSearch').value.trim();
            const packing = document.getElementById('additionalItemPacking').value.trim();
            const unit = document.getElementById('additionalItemUnit').value.trim();
            const qty = parseFloat(document.getElementById('additionalItemQty').value) || 0;
            const rate = parseFloat(document.getElementById('additionalItemRate').value) || 0;
            const remarks = document.getElementById('additionalItemRemarks').value.trim();
            
            if (!name) {
                alert('Please select an item');
                return;
            }
            
            if (!unit) {
                alert('Please enter a unit');
                return;
            }
            
            if (qty <= 0) {
                alert('Please enter a valid quantity');
                return;
            }
            
            if (rate < 0) {
                alert('Please enter a valid rate');
                return;
            }
            
            // Find the item in library to get its category
            const libraryItem = itemLibrary.find(item => item.name === name);
            const category = libraryItem ? libraryItem.category : "ADDITIONAL ITEMS";
            const amount = qty * rate;
            
            additionalItems.push({
                name: name,
                category: category,
                packing: packing,
                unit: unit,
                qty: qty,
                rate: rate,
                remarks: remarks,
                amount: amount
            });
            
            renderAdditionalItems();
            calculateTotals();
            saveToLocalStorage();
            
            // Reset form
            clearAdditionalForm();
            
            showToast(`${name} added to additional items!`, 'success');
        }

        function removeMainItem(index) {
            if (confirm('Remove this item?')) {
                mainItems.splice(index, 1);
                renderMainItems();
                calculateTotals();
                saveToLocalStorage();
            }
        }

        function removeAdditionalItem(index) {
            if (confirm('Remove this item?')) {
                additionalItems.splice(index, 1);
                renderAdditionalItems();
                calculateTotals();
                saveToLocalStorage();
            }
        }

        // ==================== RENDER FUNCTIONS ====================
        function renderQuickCategories() {
            const container = document.getElementById('quickCategories');
            container.innerHTML = categories.map(category => `
                <div class="category-badge" onclick="filterByCategory('${category}')" 
                     title="Click to search items in ${category}">
                    ${category}
                </div>
            `).join('');
        }

        function renderMainItems() {
            const container = document.getElementById('mainItemsBody');
            
            if (mainItems.length === 0) {
                container.innerHTML = `
                    <tr>
                        <td colspan="10" class="text-center text-muted py-4">
                            <i class="bi bi-cart me-2"></i>No items added yet. Search and add items above.
                        </td>
                    </tr>
                `;
                return;
            }
            
            container.innerHTML = mainItems.map((item, index) => {
                // Calculate amount if not already stored
                const amount = item.amount || (item.qty * item.rate);
                
                return `
                <tr>
                    <td>${index + 1}</td>
                    <td>
                        <div class="fw-bold">${item.name}</div>
                        <small class="text-muted">${item.category}</small>
                    </td>
                    <td>${item.category}</td>
                    <td><input type="text" class="form-control form-control-sm" value="${item.packing || ''}" 
                               onchange="updateMainItemPacking(${index}, this.value)"></td>
                    <td>${item.unit}</td>
                    <td><input type="number" class="form-control form-control-sm" value="${item.qty}" 
                               onchange="updateMainItemQty(${index}, this.value)"></td>
                    <td><input type="number" class="form-control form-control-sm" value="${item.rate.toFixed(2)}" 
                               step="0.001" onchange="updateMainItemRate(${index}, this.value)"></td>
                    <td class="amount-cell">${amount.toFixed(2)}</td>
                    <td><input type="text" class="form-control form-control-sm" value="${item.remarks || ''}" 
                               onchange="updateMainItemRemarks(${index}, this.value)"></td>
                    <td>
                        <button class="btn btn-danger btn-sm" onclick="removeMainItem(${index})">
                            <i class="bi bi-trash"></i>
                        </button>
                    </td>
                </tr>
            `}).join('');
        }

        function updateMainItemPacking(index, value) {
            mainItems[index].packing = value;
            saveToLocalStorage();
        }

        function updateMainItemQty(index, value) {
            const qty = parseFloat(value) || 0;
            if (qty > 0) {
                mainItems[index].qty = qty;
                mainItems[index].amount = qty * mainItems[index].rate;
                renderMainItems();
                calculateTotals();
                saveToLocalStorage();
            }
        }

        function updateMainItemRate(index, value) {
            const rate = parseFloat(value) || 0;
            if (rate >= 0) {
                mainItems[index].rate = rate;
                mainItems[index].amount = mainItems[index].qty * rate;
                renderMainItems();
                calculateTotals();
                saveToLocalStorage();
            }
        }

        function updateMainItemRemarks(index, value) {
            mainItems[index].remarks = value;
            saveToLocalStorage();
        }

        function renderAdditionalItems() {
            const container = document.getElementById('additionalItemsBody');
            
            if (additionalItems.length === 0) {
                container.innerHTML = `
                    <tr>
                        <td colspan="9" class="text-center text-muted py-4">
                            <i class="bi bi-plus-square me-2"></i>No additional items yet.
                        </td>
                    </tr>
                `;
                return;
            }
            
            container.innerHTML = additionalItems.map((item, index) => {
                // Calculate amount if not already stored
                const amount = item.amount || (item.qty * item.rate);
                
                return `
                <tr>
                    <td>${index + 1}</td>
                    <td>${item.name}</td>
                    <td><input type="text" class="form-control form-control-sm" value="${item.packing || ''}" 
                               onchange="updateAdditionalItemPacking(${index}, this.value)"></td>
                    <td>${item.unit}</td>
                    <td><input type="number" class="form-control form-control-sm" value="${item.qty}" 
                               onchange="updateAdditionalItemQty(${index}, this.value)"></td>
                    <td><input type="number" class="form-control form-control-sm" value="${item.rate.toFixed(2)}" 
                               step="0.001" onchange="updateAdditionalItemRate(${index}, this.value)"></td>
                    <td class="amount-cell">${amount.toFixed(2)}</td>
                    <td><input type="text" class="form-control form-control-sm" value="${item.remarks || ''}" 
                               onchange="updateAdditionalItemRemarks(${index}, this.value)"></td>
                    <td>
                        <button class="btn btn-danger btn-sm" onclick="removeAdditionalItem(${index})">
                            <i class="bi bi-trash"></i>
                        </button>
                    </td>
                </tr>
            `}).join('');
        }

        function updateAdditionalItemPacking(index, value) {
            additionalItems[index].packing = value;
            saveToLocalStorage();
        }

        function updateAdditionalItemQty(index, value) {
            const qty = parseFloat(value) || 0;
            if (qty > 0) {
                additionalItems[index].qty = qty;
                additionalItems[index].amount = qty * additionalItems[index].rate;
                renderAdditionalItems();
                calculateTotals();
                saveToLocalStorage();
            }
        }

        function updateAdditionalItemRate(index, value) {
            const rate = parseFloat(value) || 0;
            if (rate >= 0) {
                additionalItems[index].rate = rate;
                additionalItems[index].amount = additionalItems[index].qty * rate;
                renderAdditionalItems();
                calculateTotals();
                saveToLocalStorage();
            }
        }

        function updateAdditionalItemRemarks(index, value) {
            additionalItems[index].remarks = value;
            saveToLocalStorage();
        }

        function filterByCategory(category) {
            document.getElementById('itemSearch').value = category;
            document.getElementById('itemSearch').focus();
            searchItems();
        }

        // ==================== VOUCHER MANAGEMENT ====================
        function manageVouchers() {
            loadVouchers();
            const modal = new bootstrap.Modal(document.getElementById('voucherModal'));
            modal.show();
        }

        function showImportVoucherModal() {
            const modal = new bootstrap.Modal(document.getElementById('importVoucherModal'));
            modal.show();
        }

        function loadVouchers() {
            const vouchers = JSON.parse(localStorage.getItem('vouchers')) || [];
            const container = document.getElementById('voucherList');
            
            if (vouchers.length === 0) {
                container.innerHTML = '<div class="text-muted p-3">No saved vouchers</div>';
                return;
            }
            
            container.innerHTML = vouchers.map((voucher, index) => `
                <div class="voucher-list-item ${selectedVoucherId === index ? 'active' : ''}" 
                     onclick="selectVoucher(${index})">
                    <div class="fw-bold">${voucher.name || 'Unnamed Voucher'}</div>
                    <div class="small text-muted">
                        ${voucher.quoteNumber || 'No quote #'} | 
                        ${voucher.date || 'No date'} |
                        ${voucher.mainItems?.length || 0} main items,
                        ${voucher.additionalItems?.length || 0} additional items
                    </div>
                </div>
            `).join('');
            
            // Update button states
            updateVoucherButtons();
        }

        function selectVoucher(index) {
            selectedVoucherId = index;
            loadVouchers(); // Re-render to update active state
            
            // Enable buttons
            document.getElementById('loadVoucherBtn').disabled = false;
            document.getElementById('updateVoucherBtn').disabled = false;
            document.getElementById('deleteVoucherBtn').disabled = false;
            document.getElementById('exportVoucherBtn').disabled = false;
        }

        function updateVoucherButtons() {
            const hasSelection = selectedVoucherId !== null;
            document.getElementById('loadVoucherBtn').disabled = !hasSelection;
            document.getElementById('updateVoucherBtn').disabled = !hasSelection;
            document.getElementById('deleteVoucherBtn').disabled = !hasSelection;
            document.getElementById('exportVoucherBtn').disabled = !hasSelection;
        }

        function saveCurrentAsVoucher() {
            const voucherName = document.getElementById('voucherName').value.trim() || 
                               `Voucher_${new Date().toISOString().slice(0, 10)}`;
            
            const voucher = {
                name: voucherName,
                quoteNumber: document.getElementById('quoteNumber').value,
                date: document.getElementById('quoteDate').value,
                customerId: document.getElementById('customerId').value,
                validUntil: document.getElementById('validUntil').value,
                customerName: document.getElementById('customerName').value,
                poNumber: document.getElementById('poNumber').value,
                customerAddress: document.getElementById('customerAddress').value,
                mainItems: [...mainItems],
                additionalItems: [...additionalItems]
            };
            
            let vouchers = JSON.parse(localStorage.getItem('vouchers')) || [];
            vouchers.push(voucher);
            localStorage.setItem('vouchers', JSON.stringify(vouchers));
            
            showToast('Voucher saved successfully!', 'success');
            loadVouchers();
            document.getElementById('voucherName').value = '';
        }

        function loadSelectedVoucher() {
            if (selectedVoucherId === null) return;
            
            const vouchers = JSON.parse(localStorage.getItem('vouchers')) || [];
            const voucher = vouchers[selectedVoucherId];
            
            if (!voucher) {
                alert('Voucher not found');
                return;
            }
            
            // Load quotation info
            document.getElementById('quoteNumber').value = voucher.quoteNumber || '';
            document.getElementById('quoteDate').value = voucher.date || '';
            document.getElementById('customerId').value = voucher.customerId || '';
            document.getElementById('validUntil').value = voucher.validUntil || '';
            document.getElementById('customerName').value = voucher.customerName || '';
            document.getElementById('poNumber').value = voucher.poNumber || '';
            document.getElementById('customerAddress').value = voucher.customerAddress || '';
            
            // Load items
            mainItems = voucher.mainItems ? [...voucher.mainItems] : [];
            additionalItems = voucher.additionalItems ? [...voucher.additionalItems] : [];
            
            renderMainItems();
            renderAdditionalItems();
            calculateTotals();
            saveToLocalStorage();
            
            showToast(`Voucher "${voucher.name}" loaded!`, 'success');
            bootstrap.Modal.getInstance(document.getElementById('voucherModal')).hide();
        }

        function updateSelectedVoucher() {
            if (selectedVoucherId === null) return;
            
            const voucherName = document.getElementById('voucherName').value.trim() || 
                               `Voucher_${new Date().toISOString().slice(0, 10)}`;
            
            const updatedVoucher = {
                name: voucherName,
                quoteNumber: document.getElementById('quoteNumber').value,
                date: document.getElementById('quoteDate').value,
                customerId: document.getElementById('customerId').value,
                validUntil: document.getElementById('validUntil').value,
                customerName: document.getElementById('customerName').value,
                poNumber: document.getElementById('poNumber').value,
                customerAddress: document.getElementById('customerAddress').value,
                mainItems: [...mainItems],
                additionalItems: [...additionalItems]
            };
            
            let vouchers = JSON.parse(localStorage.getItem('vouchers')) || [];
            vouchers[selectedVoucherId] = updatedVoucher;
            localStorage.setItem('vouchers', JSON.stringify(vouchers));
            
            showToast('Voucher updated successfully!', 'success');
            loadVouchers();
        }

        function deleteSelectedVoucher() {
            if (selectedVoucherId === null) return;
            
            if (!confirm('Delete this voucher?')) return;
            
            let vouchers = JSON.parse(localStorage.getItem('vouchers')) || [];
            vouchers.splice(selectedVoucherId, 1);
            localStorage.setItem('vouchers', JSON.stringify(vouchers));
            
            selectedVoucherId = null;
            showToast('Voucher deleted!', 'warning');
            loadVouchers();
        }

        function exportSelectedVoucher() {
            if (selectedVoucherId === null) return;
            
            const vouchers = JSON.parse(localStorage.getItem('vouchers')) || [];
            const voucher = vouchers[selectedVoucherId];
            
            if (!voucher) {
                alert('Voucher not found');
                return;
            }
            
            const dataStr = JSON.stringify(voucher, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            saveAs(dataBlob, `voucher-${voucher.name.replace(/[^a-z0-9]/gi, '_')}.json`);
            showToast('Voucher exported successfully!', 'success');
        }

        function importVoucher() {
            const fileInput = document.getElementById('voucherFileInput');
            const jsonInput = document.getElementById('voucherJsonInput').value.trim();
            
            let voucherData = null;
            
            if (fileInput.files.length > 0) {
                const file = fileInput.files[0];
                const reader = new FileReader();
                
                reader.onload = function(e) {
                    try {
                        voucherData = JSON.parse(e.target.result);
                        processVoucherImport(voucherData);
                    } catch (error) {
                        alert('Error reading voucher file: ' + error.message);
                    }
                };
                
                reader.readAsText(file);
            } else if (jsonInput) {
                try {
                    voucherData = JSON.parse(jsonInput);
                    processVoucherImport(voucherData);
                } catch (error) {
                    alert('Error parsing JSON: ' + error.message);
                }
            } else {
                alert('Please select a file or paste JSON data');
            }
        }

        function processVoucherImport(voucherData) {
            if (!voucherData.name || !voucherData.mainItems) {
                alert('Invalid voucher format. Voucher must have name and mainItems.');
                return;
            }
            
            let vouchers = JSON.parse(localStorage.getItem('vouchers')) || [];
            
            // Check if voucher with same name already exists
            const existingIndex = vouchers.findIndex(v => v.name === voucherData.name);
            
            if (existingIndex >= 0) {
                if (!confirm(`Voucher "${voucherData.name}" already exists. Overwrite?`)) {
                    return;
                }
                vouchers[existingIndex] = voucherData;
            } else {
                vouchers.push(voucherData);
            }
            
            localStorage.setItem('vouchers', JSON.stringify(vouchers));
            showToast('Voucher imported successfully!', 'success');
            
            // Close modal
            bootstrap.Modal.getInstance(document.getElementById('importVoucherModal')).hide();
            
            // Clear inputs
            document.getElementById('voucherFileInput').value = '';
            document.getElementById('voucherJsonInput').value = '';
            
            // Refresh voucher list
            loadVouchers();
        }

        // ==================== CALCULATIONS ====================
        function calculateTotals() {
            const mainTotal = mainItems.reduce((sum, item) => sum + (item.qty * item.rate), 0);
            const additionalTotal = additionalItems.reduce((sum, item) => sum + (item.qty * item.rate), 0);
            const grandTotal = mainTotal + additionalTotal;
            
            document.getElementById('mainTotal').textContent = mainTotal.toFixed(2) + ' SAR';
            document.getElementById('additionalTotal').textContent = additionalTotal.toFixed(2) + ' SAR';
            document.getElementById('grandTotal').textContent = grandTotal.toFixed(2) + ' SAR';
        }

        // ==================== DATA MANAGEMENT ====================
        function saveToLocalStorage() {
            const data = {
                mainItems: mainItems,
                additionalItems: additionalItems,
                quotationInfo: {
                    quoteNumber: document.getElementById('quoteNumber').value,
                    date: document.getElementById('quoteDate').value,
                    customerId: document.getElementById('customerId').value,
                    validUntil: document.getElementById('validUntil').value,
                    customerName: document.getElementById('customerName').value,
                    poNumber: document.getElementById('poNumber').value,
                    customerAddress: document.getElementById('customerAddress').value
                }
            };
            localStorage.setItem('quotationData', JSON.stringify(data));
        }

        function loadFromLocalStorage() {
            const saved = localStorage.getItem('quotationData');
            if (saved) {
                try {
                    const data = JSON.parse(saved);
                    mainItems = data.mainItems || [];
                    additionalItems = data.additionalItems || [];
                    
                    if (data.quotationInfo) {
                        document.getElementById('quoteNumber').value = data.quotationInfo.quoteNumber || '';
                        document.getElementById('quoteDate').value = data.quotationInfo.date || '';
                        document.getElementById('customerId').value = data.quotationInfo.customerId || '';
                        document.getElementById('validUntil').value = data.quotationInfo.validUntil || '';
                        document.getElementById('customerName').value = data.quotationInfo.customerName || '';
                        document.getElementById('poNumber').value = data.quotationInfo.poNumber || '';
                        document.getElementById('customerAddress').value = data.quotationInfo.customerAddress || '';
                    }
                } catch (e) {
                    console.error('Error loading saved data:', e);
                }
            }
        }

        function saveQuotation() {
            saveToLocalStorage();
            showToast('Quotation saved successfully!', 'success');
        }

        // ==================== EXCEL EXPORT ====================
        async function exportToExcel() {
            try {
                const workbook = new ExcelJS.Workbook();
                const worksheet = workbook.addWorksheet('QUOTE');
                
                // Set column widths (matching your template)
                worksheet.columns = [
                    { width: 8 },  // A: SL#
                    { width: 30 }, // B: ITEMS
                    { width: 20 }, // C: PACKING
                    { width: 10 }, // D: UNIT
                    { width: 10 }, // E: QTY
                    { width: 15 }, // F: REMARKS
                    { width: 12 }, // G: Rate
                    { width: 15 }, // H: Amount
                    { width: 10 }, // I
                    { width: 10 }  // J
                ];
                
                // Header (QUOTATION in H1)
                worksheet.mergeCells('H1:J1');
                let cellH1 = worksheet.getCell('H1');
                cellH1.value = 'QUOTATION';
                cellH1.font = { bold: true, size: 16 };
                cellH1.alignment = { horizontal: 'center' };
                
                // Empty rows (2-3)
                worksheet.mergeCells('H2:J2');
                worksheet.mergeCells('H3:J3');
                
                // Quote info (matching your template)
                worksheet.getCell('D5').value = 'QUOTE #';
                worksheet.getCell('E5').value = document.getElementById('quoteNumber').value || 'Q-2026-001';
                worksheet.getCell('H5').value = 'DATE';
                worksheet.getCell('H6').value = formatDateForExcel(document.getElementById('quoteDate').value) || '05.02.2026';
                
                worksheet.getCell('D7').value = 'CUSTOMER ID';
                worksheet.getCell('E7').value = document.getElementById('customerId').value || '70226';
                worksheet.getCell('H7').value = 'VALID UNTIL';
                worksheet.getCell('H8').value = formatDateForExcel(document.getElementById('validUntil').value) || '';
                
                // Customer info
                worksheet.getCell('A10').value = 'CUSTOMER INFO:';
                worksheet.getCell('E10').value = document.getElementById('customerName').value || '';
                worksheet.getCell('H10').value = document.getElementById('customerId').value || '70226';
                
                // Customer Address
                if (document.getElementById('customerAddress').value) {
                    worksheet.getCell('A11').value = document.getElementById('customerAddress').value;
                }
                
                // PO Number
                const poRow = document.getElementById('customerAddress').value ? 12 : 11;
                worksheet.getCell(`A${poRow}`).value = `PO# ${document.getElementById('poNumber').value || '301/26/00029'}`;
                
                // Empty row
                const emptyRow = poRow + 1;
                worksheet.getCell(`A${emptyRow}`).value = '';
                
                // Table headers
                const headerRow = emptyRow + 1;
                const headers = ['SL#', 'ITEMS', 'PACKING', 'UNIT', 'QTY', 'REMARKS', 'Rate', 'Amount'];
                headers.forEach((header, idx) => {
                    const cell = worksheet.getCell(headerRow, idx + 1);
                    cell.value = header;
                    cell.font = { bold: true };
                    cell.fill = {
                        type: 'pattern',
                        pattern: 'solid',
                        fgColor: { argb: 'FFE0E0E0' }
                    };
                    cell.border = {
                        top: { style: 'thin' },
                        left: { style: 'thin' },
                        bottom: { style: 'thin' },
                        right: { style: 'thin' }
                    };
                });
                
                // Group and write main items
                let currentRow = headerRow + 1;
                let slNo = 1;
                
                // Group items by category
                const groupedItems = {};
                mainItems.forEach(item => {
                    if (!groupedItems[item.category]) {
                        groupedItems[item.category] = [];
                    }
                    groupedItems[item.category].push(item);
                });
                
                // Write items by category
                for (const [category, items] of Object.entries(groupedItems)) {
                    // Category header
                    worksheet.mergeCells(`B${currentRow}:F${currentRow}`);
                    let categoryCell = worksheet.getCell(`B${currentRow}`);
                    categoryCell.value = category;
                    categoryCell.font = { bold: true, italic: true };
                    currentRow++;
                    
                    // Category items
                    items.forEach(item => {
                        const amount = item.amount || (item.qty * item.rate);
                        
                        worksheet.getCell(`A${currentRow}`).value = slNo;
                        worksheet.getCell(`B${currentRow}`).value = item.name;
                        worksheet.getCell(`C${currentRow}`).value = item.packing || '';
                        worksheet.getCell(`D${currentRow}`).value = item.unit;
                        worksheet.getCell(`E${currentRow}`).value = item.qty;
                        worksheet.getCell(`F${currentRow}`).value = item.remarks || '';
                        worksheet.getCell(`G${currentRow}`).value = item.rate;
                        
                        // IMPORTANT: Set amount as formula E*G
                        const amountCell = worksheet.getCell(`H${currentRow}`);
                        amountCell.value = { formula: `E${currentRow}*G${currentRow}` };
                        amountCell.numFmt = '#,##0.00';
                        
                        // Add borders
                        for (let col = 1; col <= 8; col++) {
                            const cell = worksheet.getCell(currentRow, col);
                            cell.border = {
                                left: { style: 'thin' },
                                right: { style: 'thin' },
                                bottom: { style: 'thin' }
                            };
                        }
                        
                        slNo++;
                        currentRow++;
                    });
                    currentRow++; // Empty row after category
                }
                
                // Total row
                const totalRow = currentRow;
                const mainTotal = mainItems.reduce((sum, item) => sum + (item.qty * item.rate), 0);
                
                worksheet.mergeCells(`B${totalRow}:F${totalRow}`);
                let totalLabel = worksheet.getCell(`B${totalRow}`);
                totalLabel.value = 'TOTAL AMOUNT IN SAR.';
                totalLabel.alignment = { horizontal: 'right' };
                totalLabel.font = { bold: true };
                
                let totalCellH = worksheet.getCell(`H${totalRow}`);
                totalCellH.value = mainTotal;
                totalCellH.font = { bold: true };
                totalCellH.numFmt = '#,##0.00';
                
                let totalCellI = worksheet.getCell(`I${totalRow}`);
                totalCellI.value = mainTotal;
                totalCellI.font = { bold: true };
                totalCellI.numFmt = '#,##0.00';
                
                currentRow += 3; // Space after total
                
                // Additional items section
                if (additionalItems.length > 0) {
                    // Additional items title
                    worksheet.mergeCells(`B${currentRow}:F${currentRow}`);
                    let addTitle = worksheet.getCell(`B${currentRow}`);
                    addTitle.value = 'ADDITIONAL ITEMS';
                    addTitle.font = { bold: true, size: 14 };
                    currentRow += 2;
                    
                    // Additional items headers
                    const addHeaders = ['Sl #', 'Item', 'Packing', 'Unit', 'Qty', '', 'Rate', 'Amount', 'Remarks'];
                    addHeaders.forEach((header, idx) => {
                        const cell = worksheet.getCell(currentRow, idx + 1);
                        cell.value = header;
                        cell.font = { bold: true };
                        cell.fill = {
                            type: 'pattern',
                            pattern: 'solid',
                            fgColor: { argb: 'FFF0F0F0' }
                        };
                        cell.border = {
                            top: { style: 'thin' },
                            left: { style: 'thin' },
                            bottom: { style: 'thin' },
                            right: { style: 'thin' }
                        };
                    });
                    currentRow++;
                    
                    // Additional items
                    let addSlNo = 1;
                    additionalItems.forEach(item => {
                        const amount = item.amount || (item.qty * item.rate);
                        
                        worksheet.getCell(`A${currentRow}`).value = addSlNo;
                        worksheet.getCell(`B${currentRow}`).value = item.name;
                        worksheet.getCell(`C${currentRow}`).value = item.packing || '';
                        worksheet.getCell(`D${currentRow}`).value = item.unit;
                        worksheet.getCell(`E${currentRow}`).value = item.qty;
                        worksheet.getCell(`G${currentRow}`).value = item.rate;
                        
                        // IMPORTANT: Set amount as formula E*G
                        const amountCell = worksheet.getCell(`H${currentRow}`);
                        amountCell.value = { formula: `E${currentRow}*G${currentRow}` };
                        amountCell.numFmt = '#,##0.00';
                        
                        worksheet.getCell(`I${currentRow}`).value = item.remarks || '';
                        
                        // Add borders
                        for (let col = 1; col <= 9; col++) {
                            const cell = worksheet.getCell(currentRow, col);
                            cell.border = {
                                left: { style: 'thin' },
                                right: { style: 'thin' },
                                bottom: { style: 'thin' }
                            };
                        }
                        
                        currentRow++;
                        addSlNo++;
                    });
                    
                    // Additional items total
                    const addTotalRow = currentRow;
                    const addTotal = additionalItems.reduce((sum, item) => sum + (item.qty * item.rate), 0);
                    worksheet.mergeCells(`B${addTotalRow}:F${addTotalRow}`);
                    let addTotalLabel = worksheet.getCell(`B${addTotalRow}`);
                    addTotalLabel.value = 'ADDITIONAL ITEMS TOTAL';
                    addTotalLabel.alignment = { horizontal: 'right' };
                    addTotalLabel.font = { bold: true };
                    
                    let addTotalCell = worksheet.getCell(`H${addTotalRow}`);
                    addTotalCell.value = addTotal;
                    addTotalCell.font = { bold: true };
                    addTotalCell.numFmt = '#,##0.00';
                    
                    // Grand total
                    const grandTotalRow = addTotalRow + 1;
                    const grandTotal = mainTotal + addTotal;
                    worksheet.mergeCells(`B${grandTotalRow}:F${grandTotalRow}`);
                    let grandTotalLabel = worksheet.getCell(`B${grandTotalRow}`);
                    grandTotalLabel.value = 'GRAND TOTAL';
                    grandTotalLabel.alignment = { horizontal: 'right' };
                    grandTotalLabel.font = { bold: true, size: 12 };
                    
                    let grandTotalCell = worksheet.getCell(`H${grandTotalRow}`);
                    grandTotalCell.value = grandTotal;
                    grandTotalCell.font = { bold: true, size: 12 };
                    grandTotalCell.numFmt = '#,##0.00';
                }
                
                // Save the workbook
                const buffer = await workbook.xlsx.writeBuffer();
                const blob = new Blob([buffer], { 
                    type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' 
                });
                
                const quoteNumber = document.getElementById('quoteNumber').value || 'quotation';
                saveAs(blob, `quotation-${quoteNumber}.xlsx`);
                showToast('Excel file exported successfully!', 'success');
                
            } catch (error) {
                console.error('Error exporting to Excel:', error);
                showToast('Error exporting to Excel: ' + error.message, 'error');
            }
        }

        function formatDateForExcel(dateString) {
            if (!dateString) return '';
            const date = new Date(dateString);
            const day = String(date.getDate()).padStart(2, '0');
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const year = date.getFullYear();
            return `${day}.${month}.${year}`;
        }

        // ==================== UTILITY FUNCTIONS ====================
        function showToast(message, type = 'success') {
            // Remove existing toasts
            const existingToast = document.querySelector('.toast-alert');
            if (existingToast) existingToast.remove();
            
            // Create toast
            const toast = document.createElement('div');
            toast.className = `toast-alert alert alert-${type} alert-dismissible fade show position-fixed`;
            toast.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 250px;';
            toast.innerHTML = `
                ${message}
                <button type="button" class="btn-close" onclick="this.parentElement.remove()"></button>
            `;
            
            document.body.appendChild(toast);
            
            // Auto remove after 3 seconds
            setTimeout(() => {
                if (toast.parentNode) {
                    toast.remove();
                }
            }, 3000);
        }

        // Auto-save when leaving page
        window.addEventListener('beforeunload', function() {
            saveToLocalStorage();
        });

        // Auto-focus search box
        document.getElementById('itemSearch').focus();
    </script>
</body>
</html>